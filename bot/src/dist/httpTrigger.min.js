"use strict";var notificationTemplate=require("./adaptiveCards/notification-default.json"),_require=require("@microsoft/adaptivecards-tools"),AdaptiveCards=_require.AdaptiveCards,_require2=require("./internal/initialize"),bot=_require2.bot,_require3=require("@microsoft/teamsfx"),AppCredential=_require3.AppCredential,createMicrosoftGraphClientWithCredential=_require3.createMicrosoftGraphClientWithCredential,_require4=require("@microsoft/microsoft-graph-client"),ResponseType=_require4.ResponseType;module.exports=function(t){var r,n,a,o,c,s,i,p,l,u,d,m,f,h,g,v,C,I,R,x,T;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return T=function(t,r,n,a){var o,c,s,i,p,l,u,d,m,f,h,g,v,C;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return o=require("fs"),c=require("path"),s=c.basename(a),i=o.statSync(a).size,p=o.createReadStream(a),e.prev=5,e.next=8,regeneratorRuntime.awrap(n.api("/drives/".concat(t,"/root:/General/").concat(s,":/createUploadSession")).post({item:{"@microsoft.graph.conflictBehavior":"rename",name:s}}));case 8:l=e.sent,u=l.uploadUrl,m=0,f=d=327680;case 13:if(m<i)return i-f<0&&(f=i),h=Buffer.alloc(d),g=p.read(h,0,d,m),e.next=19,regeneratorRuntime.awrap(fetch(u,{method:"PUT",headers:{"Content-Range":"bytes ".concat(m,"-").concat(m+g-1,"/").concat(i)},body:h.slice(0,g)}));e.next=24;break;case 19:e.sent,m+=g,f+=d,e.next=13;break;case 24:return e.next=26,regeneratorRuntime.awrap(fetch(u,{method:"POST",headers:{"Content-Length":0}}));case 26:return e.sent,v="https://teams.microsoft.com/l/file/".concat(encodeURIComponent(s),"/preview?groupId=").concat(r,"&tenantId=").concat(appAuthConfig.tenantId,"&channelId=").concat(generalChannelId),C="https://teams.microsoft.com/_#/files/tab/".concat(r,"/").concat(t,"/").concat(encodeURIComponent(s)),console.log("File uploaded successfully to ".concat(C)),e.abrupt("return",v);case 33:throw e.prev=33,e.t0=e.catch(5),console.error("Error uploading file: ".concat(e.t0)),e.t0;case 37:case"end":return e.stop()}},null,null,[[5,33]])},x=function(t,r){var n,a,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(r.api("/teams/".concat(t,"/channels")).filter("displayName eq 'General'").select("id").get());case 2:return n=e.sent,a=n.value[0].id,e.next=6,regeneratorRuntime.awrap(r.api("/teams/".concat(t,"/channels/").concat(a,"/filesFolder")).get());case 6:return o=e.sent,c=o.parentReference.driveId,e.abrupt("return",{driveId:c,generalChannelId:a});case 9:case"end":return e.stop()}})},n=!(r=!0),a=void 0,e.prev=5,e.next=8,regeneratorRuntime.awrap(bot.notification.installations());case 8:e.t0=Symbol.iterator,o=e.sent[e.t0]();case 10:if(r=(c=o.next()).done){e.next=50;break}return s=c.value,i={authorityHost:process.env.M365_AUTHORITY_HOST,clientId:process.env.M365_CLIENT_ID,tenantId:process.env.M365_TENANT_ID,clientSecret:process.env.M365_CLIENT_SECRET},p=new AppCredential(i),l=createMicrosoftGraphClientWithCredential(p),u={"template@odata.bind":"https://graph.microsoft.com/v1.0/teamsTemplates('"+process.env.TEAMS_TEMPLATE_ID+"')",displayName:"My Incident 43-6",description:"My Incident 43-6 description",members:[{"@odata.type":"#microsoft.graph.aadUserConversationMember",roles:["owner"],"user@odata.bind":"https://graph.microsoft.com/v1.0/users/"+process.env.MOD_ID}]},e.next=18,regeneratorRuntime.awrap(l.api("/teams").responseType(ResponseType.RAW).post(u));case 18:d=e.sent,console.log(d.headers.get("client-request-id")),m=d.headers.get("Location"),f=m.match(/'([^']+)'/)[1],h="inProgress";case 23:if("succeeded"!=h)return e.next=26,regeneratorRuntime.awrap(l.api(m).get());e.next=32;break;case 26:return g=e.sent,h=g.status,e.next=30,regeneratorRuntime.awrap(new Promise(function(e){return setTimeout(e,5e3)}));case 30:e.next=23;break;case 32:return console.log("Team created successfully!"),e.next=35,regeneratorRuntime.awrap(x(f,l));case 35:return v=e.sent,C=v.driveId,I=v.generalChannelId,console.log("The driveId of the General channel for team ".concat(f," is ").concat(C)),console.log("The id of the General channel for team ".concat(f," is ").concat(I)),"C:\\OneNoteLocal\\Incident Report.pdf",e.next=43,regeneratorRuntime.awrap(T(C,f,l,"C:\\OneNoteLocal\\Incident Report.pdf"));case 43:return R=e.sent,console.log("File uploaded to General channel: ".concat(R)),e.next=47,regeneratorRuntime.awrap(s.sendAdaptiveCard(AdaptiveCards.declare(notificationTemplate).render({title:"New Incident Occurred!",appName:"Disaster Tech",description:"Welcome to the new incident team. Here is the Incident Action Plan:  ".concat(s.type),notificationUrl:R})));case 47:r=!0,e.next=10;break;case 50:e.next=56;break;case 52:e.prev=52,e.t1=e.catch(5),n=!0,a=e.t1;case 56:e.prev=56,e.prev=57,r||null==o.return||o.return();case 59:if(e.prev=59,n)throw a;e.next=62;break;case 62:return e.finish(59);case 63:return e.finish(56);case 64:t.res={};case 65:case"end":return e.stop()}},null,null,[[5,52,56,64],[57,,59,63]])};
//# sourceMappingURL=httpTrigger.min.js.map
